%% Plato FSM Translation Tech Memo
%% FSM Translation Algorithm
%%
%% Adrian Wheeldon
%% March 2017
\section{FSM Algorithm}\label{sec:algo}

In order to create a complete encoding of a state, we must first know all of the signals that exist in the system.
We do this by constructing a signal list from each causality, removing duplicates.
We then take the union of signal lists from all causalities.
In our example, we obtain the list of signals $a$, $b$, $c$.

Now we must add any signals that are missing in a causality so that we can begin to create a complete encoding.
\Cref{tab:enc} shows the new signals in bold, added with a corresponding `x', or `don't care' polarity to distinguish them and allow us to create all possible states.

Now that all signals in the design are accounted for in each causality, we can begin constructing state encodings.
We sort the signals such that the binary encoding will represent ascending signal names from left to right -- in this example, \texttt{abc}.
Since the \emph{effect} transition tells us what the effect signal \emph{will become}, we have already obtained the destination state encodings.
To obtain the \emph{source} state encodings, we must flip the polarity of the \emph{effect} transition as shown in \cref{tab:enc}.

Note that we still have `don't care' polarity in some of our state encodings.
Since this means the corresponding signal is allowed to be in either state, we must translate such states into all possible states to obtain a complete FST\@.
For example, from the final row in the table we have the states \texttt{x01}, \texttt{x11} connected by the arc $b^{-}$.
This will be expanded to the state pairs \texttt{001}, \texttt{011} and \texttt{101}, \texttt{111}.
\Cref{tab:enc_complete} gives the complete source and destination state encodings where the associated \emph{effect} denotes the FST arc label.

\begin{table}[ht]
\caption{Table}\label{tab:causality}
\centering
\begin{tabular}{@{}ll@{}}
	\toprule
	Causes & Effect\\ \midrule
	$a^{+}$, $b^{+}$	& $c^{+}$ \\
	$a^{-}$, $b^{-}$ 	& $c^{-}$ \\
	$c^{-}$			& $a^{+}$ \\
	$c^{+}$			& $a^{-}$ \\
	$c^{-}$			& $b^{+}$ \\
	$c^{+}$			& $b^{-}$ \\
	\bottomrule
\end{tabular}
\end{table}

\begin{table}[ht]
\caption{Table}\label{tab:enc}
\centering
\begin{tabular}{@{}llll@{}}
	\toprule
	& & \multicolumn{2}{c}{Encoding (\texttt{abc})}\\ \cmidrule(l){3-4}
	Causes & Effect & Destination & Source\\ \midrule
	$a^{+}$, $b^{+}$		& $c^{+}$ & \texttt{111} & \texttt{110}\\
	$a^{-}$, $b^{-}$ 		& $c^{-}$ & \texttt{000} & \texttt{001}\\
	$\mathbf{b^{x}}$, $c^{-}$	& $a^{+}$ & \texttt{1x0} & \texttt{0x0}\\
	$\mathbf{b^{x}}$, $c^{+}$	& $a^{-}$ & \texttt{0x1} & \texttt{1x1}\\
	$\mathbf{a^{x}}$, $c^{-}$	& $b^{+}$ & \texttt{x10} & \texttt{x00}\\
	$\mathbf{a^{x}}$, $c^{+}$	& $b^{-}$ & \texttt{x01} & \texttt{x11}\\
	\bottomrule
\end{tabular}
\end{table}

\begin{table}[ht]
\caption{Complete state encodings after expansion of `don't care' states.}\label{tab:enc_complete}
\centering
\begin{tabular}{@{}llll@{}}
	\toprule
	& \multicolumn{2}{c}{Encoding (\texttt{abc})}\\ \cmidrule(l){2-3}
	Effect & Destination & Source\\ \midrule
	$c^{+}$ & \texttt{111} & \texttt{110}\\[0.25em]
	$c^{-}$ & \texttt{000} & \texttt{001}\\[0.25em]
	$a^{+}$ & \texttt{100} & \texttt{000}\\
	$a^{+}$ & \texttt{110} & \texttt{010}\\[0.25em]
	$a^{-}$ & \texttt{001} & \texttt{101}\\
	$a^{-}$ & \texttt{011} & \texttt{111}\\[0.25em]
	$b^{+}$ & \texttt{010} & \texttt{000}\\
	$b^{+}$ & \texttt{110} & \texttt{100}\\[0.25em]
	$b^{-}$ & \texttt{001} & \texttt{011}\\
	$b^{-}$ & \texttt{101} & \texttt{111}\\
	\bottomrule
\end{tabular}
\end{table}

\begin{algorithm}[ht]
\begin{algorithmic}
	\caption{FSM Translation Algorithm\label{alg:fsm}}
	\For {\textbf{each} \emph{causality} ([effect], cause) \textbf{in} causalities}
		\State \textbf{removeAll} cause \textbf{from} [effect]
		\State [signalList] $\leftarrow$ \textbf{concatenate} ([effect], cause)
	\EndFor
	\State allSignals $\leftarrow$ \textbf{setUnion} ([[signalList]])
	\For {\textbf{each} \emph{transitionList} tl \textbf{in} [[signalList]]}
		\State missingTransitions $\leftarrow$ \textbf{setDifference} (tl, allSignals)
		\For {\textbf{each} \emph{transition} t \textbf{in} missingTransitions}
			\State \textbf{setPolarity} (t, `x')
		\EndFor
		\State allTransitions $\leftarrow$ \textbf{concatenate} (tl, missingTransitions)
		\State sortedTransitions $\leftarrow$ \textbf{sortBySignalName} (allTransitions)
		\State destEncodings $\leftarrow$ \textbf{getPolarity} (sortedTransitions)
		\State srcEncodings $\leftarrow$ \textbf{flipEffectPolarity} (destEncodings)
		\State incompleteArcs $\leftarrow$ \textbf{makeArcs} (srcEncodings, destEncodings)
		\State \textbf{expandX} (incompleteArcs)
	\EndFor
\end{algorithmic}
\end{algorithm}
